pipeline {
    agent any
    stages {
        stage('Pull source from GitHub.') {
            steps {
                sh 'aws --version'
                sh 'cdk --version'
                sh 'node --version'
                sh 'npm --version'
                sh 'tsc --version'
                git(url: 'https://github.com/brandonvio/mytodos.xyz', credentialsId: '058c7925-dbe1-41c8-9d81-018cfed7a721', branch: 'master')
            }
        }

        stage('Build react and lambda app.') {
            parallel {
                stage('Lambda App') {
                    steps {
                        dir('lambda-app') {
                            sh 'npm install'
                            sh 'npm run build'
                            sh 'cp -r ./build ../cdk-app-02/builds/lambda-app-build'
                        }
                    }
                }

                stage('React App') {
                    steps {
                        dir('react-app') {
                            sh 'npm install'
                            sh 'npm run build'
                            sh 'cp -r ./build ../cdk-app-02/builds/react-app-build'
                        }
                    }
                }
            }
        }

        stage('CDK App') {
            steps {
                dir('cdk-app-02') {
                    withAWS(credentials: 'kysen-build-dev', region: 'us-east-1') {
                        sh 'aws s3 ls'
                        sh 'npm install'
                        sh 'npm run build'
                        sh 'cdk deploy \\"*\\" --require-approval=never'
                    }
                }
            }
        }
    }
}
